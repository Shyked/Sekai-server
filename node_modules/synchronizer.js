(function() {


	var Worlds = require("world").Worlds;
	var Clients = require("client").Clients;
	var Player = require("player").Player;

	var Synchronizer = function() {
		this.startingWorldId = null;

		var that = this;
		Clients.addEventListener('new', function(client) {
			that.initPlayer(client);
		});
		Clients.addEventListener('delete', function(client) {
			client.data.player.clear();
		});
	};

	Synchronizer.prototype.setStartingWorldId = function(startingWorldId) {
		this.startingWorldId = startingWorldId;
	};

	Synchronizer.prototype.initPlayer = function(client) {
		client.data.player = new Player(client, this);
		var synchronizer = this;
		client.data.player.onNicknameOk = function(askedWorld) {
			this.goToWorld(askedWorld || synchronizer.startingWorldId);
			this.client.emit('chatboxMessage', JSON.stringify({
				msg: "Welcome in Sekai, " + this.nickname + " !",
				nickname: "",
				color: {
					r: 60,
					g: 150,
					b: 255
				},
				type: 2
			}));
		};
	};





	var singleSynchronizer = new Synchronizer();
	exports.Synchronizer = singleSynchronizer;


})();